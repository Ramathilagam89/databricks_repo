{"version":"NotebookV1","origId":3751029543617040,"name":"gold_analytics_advanced5b","language":"python","commands":[{"version":"CommandV1","origId":3751029543617041,"guid":"77bb6f09-7fb0-49b5-936d-0a3354485c94","subtype":"command","commandType":"auto","position":1.0,"command":"dbutils.widgets.text(\"catalog\",\"\")\nCATALOG=dbutils.widgets.get(\"catalog\").strip()\ndbutils.widgets.text(\"schema\",\"\")\nSCHEMA=dbutils.widgets.get(\"schema\").strip()","commandVersion":1,"state":"finished","results":{"type":"listResults","data":[],"arguments":{},"addedWidgets":{},"removedWidgets":[],"datasetInfos":[],"metadata":{}},"resultDbfsStatus":"INLINED_IN_TREE","resultDbfsErrorMessage":null,"errorSummary":null,"errorTraceType":null,"error":null,"errorDetails":null,"baseErrorDetails":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"latestAssumeRoleInfo":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"metadata":{},"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"tableResultIndex":null,"listResultMetadata":[],"subcommandOptions":null,"contentSha256Hex":null,"tableResultSettingsMap":{},"nuid":"016f884e-9294-4b9b-aebe-c0ee1818ae07"},{"version":"CommandV1","origId":3751029543617042,"guid":"3505ed02-c6d6-4cf1-a4b6-3ae1bce51e14","subtype":"command","commandType":"auto","position":2.0,"command":"%python\nimport json\n\nconfig_nb_output = dbutils.notebook.run(\n    \"/Workspace/Users/loganathansundaramsa@gmail.com/dataengg_inc_learning/databricks_learning/generic_project/general_conf_utils_1_2/configs_path1\",\n    120,{\"catalog\": CATALOG,\"schema\": SCHEMA})\n\nconfig_dict = json.loads(config_nb_output)\n\nCATALOG = config_dict[\"CATALOG\"]\nSCHEMA = config_dict[\"SCHEMA\"]\nSRC=config_dict[\"SRC\"]\nBRONZE = config_dict[\"BRONZE\"]\nSILVER = config_dict[\"SILVER\"]\nGOLD = config_dict[\"GOLD\"]\nSILVERDB = config_dict[\"SILVERDB\"]\nGOLDDB = config_dict[\"GOLDDB\"]","commandVersion":3,"state":"finished","results":{"type":"listResults","data":[],"arguments":{},"addedWidgets":{},"removedWidgets":[],"datasetInfos":[],"metadata":{}},"resultDbfsStatus":"INLINED_IN_TREE","resultDbfsErrorMessage":null,"errorSummary":null,"errorTraceType":null,"error":null,"errorDetails":null,"baseErrorDetails":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"latestAssumeRoleInfo":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"metadata":{},"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"tableResultIndex":null,"listResultMetadata":[],"subcommandOptions":null,"contentSha256Hex":null,"tableResultSettingsMap":{},"nuid":"839133ad-6564-4e1b-acc3-bd15ac03b2ce"},{"version":"CommandV1","origId":3751029543617043,"guid":"78626399-cfb0-47c9-bc44-aa0597c0bf05","subtype":"command","commandType":"auto","position":3.0,"command":"%run /Workspace/Users/loganathansundaramsa@gmail.com/dataengg_inc_learning/databricks_learning/generic_project/general_conf_utils_1_2/util_functions2","commandVersion":2,"state":"finished","results":{"type":"listResults","data":[],"arguments":{},"addedWidgets":{},"removedWidgets":[],"datasetInfos":[],"metadata":{}},"resultDbfsStatus":"INLINED_IN_TREE","resultDbfsErrorMessage":null,"errorSummary":null,"errorTraceType":null,"error":null,"errorDetails":null,"baseErrorDetails":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"latestAssumeRoleInfo":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"metadata":{"byteLimit":2048000,"rowLimit":10000},"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"tableResultIndex":null,"listResultMetadata":[],"subcommandOptions":null,"contentSha256Hex":null,"tableResultSettingsMap":{},"nuid":"d8ae37a3-4db7-4824-8a4b-6538e24d0366"},{"version":"CommandV1","origId":3751029543617044,"guid":"40c0ebb4-1b65-419d-8882-9d7854ba8ac7","subtype":"command","commandType":"auto","position":4.0,"command":"from pyspark.sql.window import Window\n\ndf = spark.read.format(\"delta\").load(f\"{GOLD}/core_curated\")\ndf.show()\n# TOP 3 DRIVERS BY COST PER HUB\nw = Window.partitionBy(\"origin_hub_city\") \\\n          .orderBy(F.col(\"shipment_cost\").desc())\n\ntop3 = df.withColumn(\"rank\", F.dense_rank().over(w)) \\\n         .filter(\"rank <= 3\")\n\n# LEAD / LAG\nlag_df = df.withColumn(\n    \"prev_shipment_days\",\n    F.lag(\"shipment_year\").over(\n        Window.partitionBy(\"masked_staff_name\").orderBy(\"shipment_year\")\n    )\n)\n\n# CUBE AGGREGATION\ncube_df = df.cube(\"origin_hub_city\") \\\n    .agg(F.sum(\"shipment_cost\").alias(\"total_cost\"))\n\nwrite_file(top3,f\"{GOLD}/top3_drivers\")\nwrite_file(lag_df,f\"{GOLD}/prev_shipment_days\")\nwrite_file(cube_df,f\"{GOLD}/cube_costs\")","commandVersion":1,"state":"finished","results":{"type":"listResults","data":[],"arguments":{},"addedWidgets":{},"removedWidgets":[],"datasetInfos":[],"metadata":{}},"resultDbfsStatus":"INLINED_IN_TREE","resultDbfsErrorMessage":null,"errorSummary":null,"errorTraceType":null,"error":null,"errorDetails":null,"baseErrorDetails":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"latestAssumeRoleInfo":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"metadata":{"byteLimit":2048000,"rowLimit":10000},"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"tableResultIndex":null,"listResultMetadata":[],"subcommandOptions":null,"contentSha256Hex":null,"tableResultSettingsMap":{},"nuid":"4f8b0840-3442-4772-b3fe-4bb66dd7ea82"}],"dashboards":[],"guid":"d16697de-59d6-493a-bbee-16566af45b8e","globalVars":{},"iPythonMetadata":{"nbformat":4,"IPythonMetadata":{"language_info":{"name":"python"}}},"inputWidgets":{},"notebookMetadata":{"mostRecentlyExecutedCommandWithImplicitDF":{"commandId":6358089889637120,"dataframes":["_sqldf"]},"pythonIndentUnit":4},"reposExportFormat":"JUPYTER","environmentMetadata":{"client":"4","base_environment":""},"computePreferences":null,"inputWidgetPreferences":null,"environmentSerializationPreferences":null}